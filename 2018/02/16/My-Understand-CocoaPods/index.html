<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 我所理解的 CocoaPods · Hexo</title><meta name="description" content="我所理解的 CocoaPods - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/avatar.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Hexo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/avatar.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/3290954642" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/boolchow" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">我所理解的 CocoaPods</h1><div class="post-info">Feb 16, 2018</div><div class="post-content"><a id="more"></a>
<p>很久之前读了一遍 <a href="https://guides.cocoapods.org/" target="_blank" rel="noopener">Cocoa Pods 官方文档</a>，对 Cocoa Pods 有了一个简单的了解。时隔多日，全忘了。</p>
<p>所以再回顾一下，顺便写一篇总结。文章分为<strong>原理</strong>和<strong>使用</strong>两部分，比较长，可以根据自己的需求选择性阅读。</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>CocoaPods 是开发 OS X 和 iOS 应用程序的一个第三方库的依赖管理工具，使用这个工具可以简化对组件依、更新的过程。新添加一些第三方组件可以直接修改 podfile 然后进行 <code>pod install</code>；更新已有第三方组件，可以修改 podfile 然后进行 <code>pod update</code>；自己开发的组件也可以上传到 CocoaPods 或者私有仓库，供其他人使用。</p>
<p>CocoaPods 是用 ruby 写的，由若干个 gems 组成。也就是说，iOS project 使用 CocoaPods 来进行组件管理，CocoaPods 本身也是一个 project，它使用 gem 进行组件管理。</p>
<p>开始写这篇文章的时候，我想先写使用，再写原理。因为我担心很多人感觉原理晦涩难懂，就放弃看后面了。但构思的时候发现，明白了原理之后，对一些命令的使用会有更深刻的了解。所以还是决定将原理放在前面讲。</p>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><h4 id="1-CocoaPods-结构"><a href="#1-CocoaPods-结构" class="headerlink" title="1.CocoaPods 结构"></a>1.CocoaPods 结构</h4><p>CocoaPods 是用 Ruby 写的，并由若干个 Ruby 包 (gems) 构成的，源码托管在 <a href="https://github.com/CocoaPods" target="_blank" rel="noopener">GitHub</a> 上。其中主要的几个组件为：</p>
<ul>
<li><p><strong><a href="https://github.com/CocoaPods/Specs" target="_blank" rel="noopener">CocoaPods/Specs</a></strong><br>这个是一个保存第三方组件 podspec 文件的仓库。第三方组件开发完成之后，会传一份 podspec 文件传到 CocoaPods，这个 Specs 包含了每个第三方组件所有版本的 podspec 文件。当使用某个第三方组件时，如果这些组件支持 CocoaPods，会在 Podfile 中指定 source，例如下面这样：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source <span class="string">'https://github.com/CocoaPods/Specs.git'</span></span><br></pre></td></tr></table></figure>
<p>当执行 <code>pod install</code> 或 <code>pod update</code> 等一些命令时，便会从这个仓库找到组件指定版本的 podspec 文件，然后根据这个 podspec 配置信息去获取组件。</p>
</li>
<li><p><strong><a href="https://github.com/CocoaPods/CocoaPods" target="_blank" rel="noopener">CocoaPods/CocoaPods</a></strong><br>这是是一个面向用户的组件，每当执行一个 pod 命令时，这个组件都将被激活。该组件包括了所有使用 CocoaPods 涉及到的功能，并且还能通过调用所有其它的 gems 来执行任务。</p>
</li>
<li><p><strong><a href="https://github.com/CocoaPods/Core" target="_blank" rel="noopener">CocoaPods/Core</a></strong><br>这个 gem 组件提供支持与 CocoaPods 相关文件的处理，例如 <a href="https://guides.cocoapods.org/syntax/podspec.html" target="_blank" rel="noopener">Specification</a>、<a href="https://guides.cocoapods.org/syntax/podfile.html" target="_blank" rel="noopener">Podfile</a> 和 <a href="https://github.com/CocoaPods/Specs" target="_blank" rel="noopener">Source</a>。当执行 <code>pod install</code> 等一些命令时。Core 组件会解析第三方组件开发者上传的 podspec 文件和使用者的 podfile,以此确定需要为 project 引入哪些文件。除此之外，当执行与这些文件一些相关的命令时，也由这部分组件处理，例如使用 <code>pod spec lint</code> 来检测 podspec 文件的有效性。</p>
</li>
<li><p><strong><a href="https://github.com/CocoaPods/Xcodeproj" target="_blank" rel="noopener">CocoaPods/Xcodeproj</a></strong><br>使用这个 gem 组件，你可以用 ruby 来创建并修改 Xcode projects。在 CocoaPods 中它负责所有工程文件的整合。如果你想要写一个脚本来方便的修改工程文件，那么可以单独下载这个 gem 并使用。更多信息可以查看工程的 <a href="https://github.com/CocoaPods/Xcodeproj" target="_blank" rel="noopener">readme</a>。</p>
</li>
</ul>
<h4 id="2-几个相关文件"><a href="#2-几个相关文件" class="headerlink" title="2.几个相关文件"></a>2.几个相关文件</h4><ul>
<li><p><strong>Specification</strong></p>
<p>这个文件用来描述第三方组件某个版本的信息。主要包含了组件拉取地址、应该拉取那些文件和项目配置信息。除此之外，还包含一些组件信息，例如组件的名字、版本等。后面章节会详细讲解字段含义和文件书写规范。</p>
</li>
<li><p><strong>Podfile</strong> </p>
<p>这个文件用来指定工程中依赖了那些组件。主要包含了依赖的组件名、组件版本、组件地址等。后面章节会详细讲解字段含义和文件书写规范。</p>
</li>
<li><p><strong>Podfile.lock</strong></p>
<p>在第一次执行 <code>pod install</code> 时，执行完毕后会生成一个 podfile.lock 文件。这个文件主要标注了项目当前依赖的具体版本。看下面这个文件信息：</p>
<p><img src="/uploads/Cocoa-Pods/PodfileLock.png" alt="PodfileLock.png"></p>
</li>
</ul>
<p> 有个问题需要牢记：<strong>CocoaPods 强烈建议将 Podfile.lock 文件加入版本管理，这样其他人同步了你的 podfile.lock 文件之后，执行 <code>pod install</code> 时会将按照里面指定给的版本加载，避免多人协作时发生冲突</strong>。后面的 pod install vs pod update 会详细讲解 podfile.lock 变更时机。</p>
<ul>
<li><strong>Manifest.lock</strong></li>
</ul>
<p>Manifest.lock 是由 Podfile.lock 生成的一个副本，每次生成或者更新 Podfile.lock，都会更下 Pods 文件夹下面的 Manifest.lock 文件。如果你遇见过这样的错误 沙盒文件与 Podfile.lock 文件不同步 (The sandbox is not in sync with the Podfile.lock)，这是因为 Manifest.lock 文件和 Podfile.lock 文件不一致所引起。</p>
<h4 id="3-相互关系"><a href="#3-相互关系" class="headerlink" title="3.相互关系"></a>3.相互关系</h4><p> <img src="/uploads/Cocoa-Pods/三者关系.png" alt="三者关系"></p>
<p>上图为组件开发者、CocoaPods、组件使用者三者的关系。</p>
<p>组件开发者开发完组件之后，会将组件上传到仓库 (Github or other)。然后创建一个 podspec 文件，文件中包含了使用组件时需要加载哪些文件以及从哪里加载。然后会将这个文件上传到 CocoaPods（也可以上传至私人构建的 spec 管理仓库）。</p>
<p>组件使用者想要使用某个组件，会在 Podfile 中指定组件的名字、版本、加载源以及更加详细的信息（例如想要加载某个 commit）。然后执行相关 Pod 命令。</p>
<p>CocoaPods 执行 Pod 命令，然后解析对应的 podspec 文件，确定需要加载的文件信息并将文件加载到项目工程里。并创建 Podfile.lock、Manifest.lock、Pods.xcodeproj 等文件。</p>
<h4 id="4-一次详细的加载过程"><a href="#4-一次详细的加载过程" class="headerlink" title="4.一次详细的加载过程"></a>4.一次详细的加载过程</h4><p>前面提到 CocoaPods 是开源的，所以我们可以把源码下载下来进行研究。<code>pod install</code> 这个命令定义在 <a href="https://github.com/CocoaPods/Core" target="_blank" rel="noopener">CocoaPods/Core</a> 这 gem 中。</p>
<h5 id="执行-pod-install-命令"><a href="#执行-pod-install-命令" class="headerlink" title="执行 pod install 命令"></a>执行 pod install 命令</h5><p>所有命令都是通过 <code>Command</code> 类管理的，执行 <code>pod install</code> 时代码如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/command/install.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Pod</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Command</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Install</span> &lt; Command</span></span><br><span class="line">    </span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">run</span></span></span><br><span class="line">        verify_podfile_exists!</span><br><span class="line">        installer = installer_for_config</span><br><span class="line">        installer.repo_update = repo_update?(<span class="symbol">:default</span> =&gt; <span class="literal">false</span>)</span><br><span class="line">        installer.update = <span class="literal">false</span></span><br><span class="line">        installer.install!</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>执行时会先生成一个 <code>installer</code> 实例。然后设置 <code>repo_update</code> 属性和 <code>update</code> 属性，最后执行 <code>install</code> 方法。</p>
<h5 id="Podfile-解析"><a href="#Podfile-解析" class="headerlink" title="Podfile 解析"></a>Podfile 解析</h5><p>执行 <code>pod install</code> 命令具体细节前，首先要解析 Podfile。这一过程在初始化 <code>installer</code> 实例时就已经开始：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">installer_for_config</span></span></span><br><span class="line">  Installer.new(config.sandbox, config.podfile, config.lockfile)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5 id="pod-install-方法定义"><a href="#pod-install-方法定义" class="headerlink" title="pod install 方法定义"></a>pod install 方法定义</h5><p>pod install 方法定义如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">install!</span></span></span><br><span class="line">  prepare</span><br><span class="line">  resolve_dependencies</span><br><span class="line">  download_dependencies</span><br><span class="line">  validate_targets</span><br><span class="line">  generate_pods_project</span><br><span class="line">  <span class="keyword">if</span> installation_options.integrate_targets?</span><br><span class="line">    integrate_user_project</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    UI.section <span class="string">'Skipping User Project Integration'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  perform_post_install_actions</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>从方法定义中，可以看出 <code>pod install</code> 的执行分为如下几部：<strong>准备阶段、解决依赖冲突、下载依赖文件、校验 target、整合 project 文件、输出执行结果</strong>。下面将按照这个步骤逐步分析。</p>
<h5 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h5><p>准备阶段代码如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span></span></span><br><span class="line">  <span class="comment"># Raise if pwd is inside Pods</span></span><br><span class="line">  <span class="keyword">if</span> Dir.pwd.start_with?(sandbox.root.to_path)</span><br><span class="line">    message = <span class="string">'Command should be run from a directory outside Pods directory.'</span></span><br><span class="line">    message &lt;&lt; <span class="string">"\n\n\tCurrent directory is <span class="subst">#&#123;UI.path(Pathname.pwd)&#125;</span>\n"</span></span><br><span class="line">    raise Informative, message</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  UI.message <span class="string">'Preparing'</span> <span class="keyword">do</span></span><br><span class="line">    deintegrate_if_different_major_version</span><br><span class="line">    sandbox.prepare</span><br><span class="line">    ensure_plugins_are_installed!</span><br><span class="line">    run_plugins_pre_install_hooks</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>首先会检测目录结构，是否为可执行 pod 命令的目录，如果不是直接输出信息。如果可执行，则做一些准备工作。如果你的 Podfile 中写了一些 hooks，也会在这里执行。</p>
<h5 id="解决依赖冲突"><a href="#解决依赖冲突" class="headerlink" title="解决依赖冲突"></a>解决依赖冲突</h5><p>这一阶段的方法定义如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resolve_dependencies</span></span></span><br><span class="line"> plugin_sources = run_source_provider_hooks</span><br><span class="line"> analyzer = create_analyzer(plugin_sources)</span><br><span class="line"></span><br><span class="line"> UI.section <span class="string">'Updating local specs repositories'</span> <span class="keyword">do</span></span><br><span class="line">   analyzer.update_repositories</span><br><span class="line"> <span class="keyword">end</span> <span class="keyword">if</span> repo_update?</span><br><span class="line"></span><br><span class="line"> UI.section <span class="string">'Analyzing dependencies'</span> <span class="keyword">do</span></span><br><span class="line">   analyze(analyzer)</span><br><span class="line">   validate_build_configurations</span><br><span class="line">   clean_sandbox</span><br><span class="line"> <span class="keyword">end</span></span><br><span class="line"> analyzer</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>根据方法定义，我们可以看出这一阶段处理的事情：启动 hooks 并创建一个 <code>analyzer</code>，然后使用这个 <code>analyzer</code> 更新本地 specs 库、处理版本依赖。</p>
<p>首先是创建 <code>analyzer</code>，创建过程中将 <code>Podfile</code> 和 <code>lockfile</code> 等一些文件信息全部传入，并在这个类中将这些文件解析。创建 <code>analyzer</code> 代码如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_analyzer</span><span class="params">(plugin_sources = <span class="literal">nil</span>)</span></span></span><br><span class="line">  Analyzer.new(sandbox, podfile, lockfile, plugin_sources).tap <span class="keyword">do</span> <span class="params">|analyzer|</span></span><br><span class="line">    analyzer.installation_options = installation_options</span><br><span class="line">    analyzer.has_dependencies = has_dependencies?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>然后是更新本地 specs 库。从代码中可以看出有一个 <code>repo_update?</code> 判断，也就是说这个标志位真的时候，才会更新本地 specs 库。也就是我们常用的一条命令：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod repo udpate</span><br></pre></td></tr></table></figure>
<p>最后是处理依赖关系。其中 <code>Podfile</code>、<code>lockfile</code> 也是使用 <code>Analyzer</code> 这个类中解析。下面是解析方法的定义 ：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer/analyzer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyze</span><span class="params">(allow_fetches = <span class="literal">true</span>)</span></span></span><br><span class="line">    validate_podfile!	<span class="comment"># step1: 解析并校验 podfile</span></span><br><span class="line">    validate_lockfile_version! <span class="comment"># step2: 解析并校验 lockfile 中的库的版本</span></span><br><span class="line">    @result = AnalysisResult.new <span class="comment"># step3: 新建 result 实例</span></span><br><span class="line">    ...</span><br><span class="line">    @result.specifications  = generate_specifications(resolver_specs_by_target)</span><br><span class="line">    @result.targets         = generate_targets(resolver_specs_by_target)</span><br><span class="line">    @result.sandbox_state   = generate_sandbox_state</span><br><span class="line">    @result.specs_by_target = resolver_specs_by_target.each_with_object(&#123;&#125;) <span class="keyword">do</span> <span class="params">|rspecs_by_target, hash|</span></span><br><span class="line">      hash[rspecs_by_target[<span class="number">0</span>]] = rspecs_by_target[<span class="number">1</span>].map(&amp;<span class="symbol">:spec</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    @result.specs_by_source = Hash[resolver_specs_by_target.values.flatten(<span class="number">1</span>).group_by(&amp;<span class="symbol">:source</span>).map &#123; <span class="params">|source, specs|</span> [source, specs.map(&amp;<span class="symbol">:spec</span>).uniq] &#125;]</span><br><span class="line">    sources.each &#123; <span class="params">|s|</span> @result.specs_by_source[s] <span class="params">||</span>= [] &#125;</span><br><span class="line">    @result</span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>最终会将解析结果保存在一个 <code>@result</code> 实例中，进行后面步骤时，会使用这个解析结果。<code>AnalysisResult</code> 类定义如下，注释我就不翻译了，看原味的英文更有助于理解具体意思：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer/analyzer/analysis_result.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Pod</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Installer</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Analyzer</span></span></span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">AnalysisResult</span></span></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [SpecsState] the states of the Podfile specs.</span></span><br><span class="line">        <span class="keyword">attr_accessor</span> <span class="symbol">:podfile_state</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [Hash&#123;TargetDefinition =&gt; Array&lt;Specification&gt;&#125;] the</span></span><br><span class="line">        <span class="comment">#         specifications grouped by target.</span></span><br><span class="line">        <span class="keyword">attr_accessor</span> <span class="symbol">:specs_by_target</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [Hash&#123;Source =&gt; Array&lt;Specification&gt;&#125;] the</span></span><br><span class="line">        <span class="comment">#         specifications grouped by spec repo source.</span></span><br><span class="line">        <span class="keyword">attr_accessor</span> <span class="symbol">:specs_by_source</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [Array&lt;Specification&gt;] the specifications of the resolved</span></span><br><span class="line">        <span class="comment">#         version of Pods that should be installed.</span></span><br><span class="line">        <span class="keyword">attr_accessor</span> <span class="symbol">:specifications</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [SpecsState] the states of the &#123;Sandbox&#125; respect the resolved</span></span><br><span class="line">        <span class="comment">#         specifications.</span></span><br><span class="line">        <span class="keyword">attr_accessor</span> <span class="symbol">:sandbox_state</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [Array&lt;AggregateTarget&gt;] The aggregate targets created for each</span></span><br><span class="line">        <span class="comment">#         &#123;TargetDefinition&#125; from the &#123;Podfile&#125;.</span></span><br><span class="line">        <span class="keyword">attr_accessor</span> <span class="symbol">:targets</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [Hash&#123;TargetDefinition =&gt; Array&lt;TargetInspectionResult&gt;&#125;] the</span></span><br><span class="line">        <span class="comment">#         results of inspecting the user targets</span></span><br><span class="line">        <span class="keyword">attr_accessor</span> <span class="symbol">:target_inspections</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">@return</span> [Hash&#123;String=&gt;Symbol&#125;] A hash representing all the user build</span></span><br><span class="line">        <span class="comment">#         configurations across all integration targets. Each key</span></span><br><span class="line">        <span class="comment">#         corresponds to the name of a configuration and its value to</span></span><br><span class="line">        <span class="comment">#         its type (`:debug` or `:release`).</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">all_user_build_configurations</span></span></span><br><span class="line">          targets.reduce(&#123;&#125;) <span class="keyword">do</span> <span class="params">|result, target|</span></span><br><span class="line">            result.merge(target.user_build_configurations)</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>关于 <code>Podfile</code> 的解析过程，有兴趣的可以查看一下 <code>PodfileValidator</code> 类，在目录 <code>CocoaPods/lib/cocoapods/installer/analyzer/podfile_validator.rb</code>。</p>
<h5 id="下载依赖文件"><a href="#下载依赖文件" class="headerlink" title="下载依赖文件"></a>下载依赖文件</h5><p>下载依赖文件方法定义如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_dependencies</span></span></span><br><span class="line">  UI.section <span class="string">'Downloading dependencies'</span> <span class="keyword">do</span></span><br><span class="line">    create_file_accessors</span><br><span class="line">    install_pod_sources</span><br><span class="line">    run_podfile_pre_install_hooks</span><br><span class="line">    clean_pod_sources</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这个方法中调用了几个其他方法。作用分别为：创建文件存储器，以便向沙盒里面写入数据；下载数据；启动 hooks；进行清理操作。具体每个方法的定义，可以查看文件源码。这里主要说一下 <code>install_pod_sources</code> 方法。</p>
<p><code>install_pod_sources</code> 方法定义如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="comment"># Downloads, installs the documentation and cleans the sources of the Pods</span></span><br><span class="line"><span class="comment"># which need to be installed.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">@return</span> [void]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">install_pod_sources</span></span></span><br><span class="line">  @installed_specs = []</span><br><span class="line">  pods_to_install = sandbox_state.added <span class="params">| sandbox_state.changed</span></span><br><span class="line"><span class="params">  title_options = &#123; :verbose_prefix =&gt; '-&gt; '.green &#125;</span></span><br><span class="line"><span class="params">  root_specs.sort_by(&amp;:name).each <span class="keyword">do</span> |</span>spec<span class="params">|</span></span><br><span class="line"><span class="params">    <span class="keyword">if</span> pods_to_install.<span class="keyword">include</span>?(spec.name)</span></span><br><span class="line"><span class="params">      <span class="keyword">if</span> sandbox_state.changed.<span class="keyword">include</span>?(spec.name) &amp;&amp; sandbox.manifest</span></span><br><span class="line"><span class="params">        previous = sandbox.manifest.version(spec.name)</span></span><br><span class="line"><span class="params">        title = "Installing #&#123;spec.name&#125; #&#123;spec.version&#125; (was #&#123;previous&#125;)"</span></span><br><span class="line"><span class="params">      <span class="keyword">else</span></span></span><br><span class="line"><span class="params">        title = "Installing #&#123;spec&#125;"</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">      UI.titled_section(title.green, title_options) <span class="keyword">do</span></span></span><br><span class="line"><span class="params">        install_source_of_pod(spec.name)</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    <span class="keyword">else</span></span></span><br><span class="line"><span class="params">      UI.titled_section("Using #&#123;spec&#125;", title_options) <span class="keyword">do</span></span></span><br><span class="line"><span class="params">        create_pod_installer(spec.name)</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">  <span class="keyword">end</span></span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>首先确定需要 install 的组件。这里主要针对新加的组件和变更的组件进行 install，至于这些信息是通过 <code>sandbox_state</code> 获取的。然而 <code>sandbox_state</code> 方法定义如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sandbox_state</span></span></span><br><span class="line">  analysis_result.sandbox_state</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这里的 <code>analysis_result</code> 就是我们上一步中解析出的结果，在这里用到了。</p>
<p>第二步创建 title 配置信息，后面针对变更的组件，会用这个配置标记。相信每一位开发者进行 pod install 操作的时候，都会注意到变更的组件自动标记为绿色。</p>
<p>最后一步是下载对应文件。这里分了三种情况：如果组件已经下载且版本号没有发生变化，则直接提示 “Using xxx”，如下图中的 “YYCache” 组件；如果组件已经下载，但是版本号发生了变化，则更新组件并提示 “Installing xxx 版本号 (之前版本号)”，如下图中的 “AFNetworking” 组件；如果组件第一次下载，则进行下载，并提示 “Installing xxx”，如下图中的 “YYImage”。</p>
<p><img src="/uploads/Cocoa-Pods/podInstall.png" alt="podInstall.png"></p>
<h5 id="校验-target"><a href="#校验-target" class="headerlink" title="校验 target"></a>校验 target</h5><p>校验 target 代码如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_targets</span></span></span><br><span class="line">  validator = Xcode::TargetValidator.new(aggregate_targets, pod_targets)</span><br><span class="line">  validator.validate!</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer/xcode/target_validator.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate!</span></span></span><br><span class="line">  verify_no_duplicate_framework_and_library_names</span><br><span class="line">  verify_no_static_framework_transitive_dependencies</span><br><span class="line">  verify_no_pods_used_with_multiple_swift_versions</span><br><span class="line">  verify_framework_usage</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这个方法中，创建了一个 <code>TargetValidator</code> 实例，并调用 <code>validate()</code> 方法进行校验。这方方法主要分为以下几步：</p>
<ul>
<li><p>检测是否有多重引用 framework 或者 library 的情况。因为一个组件可能分成多个 subspec，如果不清楚 subspec 中的依赖关系。使用时可能会出现多重引用的情况。举个例子，下面是 “<a href="https://github.com/netease-im/NIM_iOS_UIKit/blob/master/NIMKit.podspec" target="_blank" rel="noopener">网易云信</a>“ 的 podspec 文件，以及其中依赖的两个组件的 podspec 文件:</p>
  <figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment"># NIMKit.podspec</span></span><br><span class="line">Pod::Spec.new <span class="keyword">do</span> <span class="params">|s|</span> </span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  s.subspec <span class="string">'Full'</span> <span class="keyword">do</span> <span class="params">|cs|</span>	</span><br><span class="line">    cs.source_files = <span class="string">'NIMKit/NIMKit/**/*.&#123;h,m&#125;'</span> </span><br><span class="line">    cs.dependency <span class="string">'NIMKit/Core'</span> </span><br><span class="line">    cs.dependency <span class="string">'NIMSDK'</span>, <span class="string">'~&gt; 4.9.0'</span> </span><br><span class="line">  <span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">  s.subspec <span class="string">'Lite'</span> <span class="keyword">do</span> <span class="params">|cs|</span>  </span><br><span class="line">    cs.source_files = <span class="string">'NIMKit/NIMKit/**/*.&#123;h,m&#125;'</span>  </span><br><span class="line">    cs.dependency <span class="string">'NIMKit/Core'</span>  </span><br><span class="line">    cs.dependency <span class="string">'NIMSDK_LITE'</span>, <span class="string">'~&gt; 4.9.0'</span>  </span><br><span class="line">  <span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line">  s.subspec <span class="string">'Core'</span> <span class="keyword">do</span> <span class="params">|os|</span>     </span><br><span class="line">	...</span><br><span class="line">  <span class="keyword">end</span>   </span><br><span class="line"></span><br><span class="line">  s.default_subspec = <span class="string">'Lite'</span>  </span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">	<span class="comment"># NIMSDK.podspec</span></span><br><span class="line">	Pod::Spec.new <span class="keyword">do</span> <span class="params">|s|</span>   </span><br><span class="line"> 	...</span><br><span class="line">  s.vendored_libraries  = <span class="string">'**/Libs/*.a'</span> </span><br><span class="line">  s.vendored_frameworks = <span class="string">'**/NIMSDK.framework'</span>,<span class="string">'**/NIMAVChat.framework'</span></span><br><span class="line">	... </span><br><span class="line"> <span class="keyword">end</span> </span><br><span class="line">  </span><br><span class="line">  	<span class="comment"># NIMSDK_LITE.podspec</span></span><br><span class="line">Pod::Spec.new <span class="keyword">do</span> <span class="params">|s|</span>   </span><br><span class="line"> ...</span><br><span class="line">  s.vendored_libraries  = <span class="string">'NIMSDK/Libs/*.a'</span></span><br><span class="line">  s.vendored_frameworks = <span class="string">'**/NIMSDK.framework'</span>  </span><br><span class="line"> ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>然后我这样去引用：

<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">'NIMKit'</span>, <span class="symbol">:subspecs</span> =&gt; [<span class="string">'Lite'</span>,<span class="string">'Full'</span>]</span><br></pre></td></tr></table></figure>

因为两个 spec 中都引用了 NIMKit framework，所以执行 `pod install` 的时候就会出现如下问题：
</code></pre><p><img src="/uploads/Cocoa-Pods/target_confilct.png" alt="target_confilct.png"></p>
<pre><code>&gt; 这里还是不太理解，可能表述有误。如果清楚请指出，我加以改正。
</code></pre><ul>
<li><p>处理静态库传递依赖问题。如果 A 组件依赖 B 组件，B 组件中含有通过vendored_libraries加载的静态库.a或framewrok。如果 <code>Podfile</code> 中不使用 <code>use_frameworks!</code>，不会出现任何问题；如果使用 <code>use_frameworks!</code>，那么打包的 <code>framework</code> 会将 <code>vendored_libraries</code> 库中的内容包含进来，这就出现了符号冲突的问题了。如果出现了这种问题，CocoaPods 会报出如下错误：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The &apos;pod-name&apos; target has transitive dependencies that include static binaries: (static_libs.to_sentence)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>因为在 swift 中必须使用 `use_frameworks`，所以 swift 中经常会遇到这种问题。解决办法就是修改 `podspec` 和 `Podfile` 两个文件：

podspec

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s.dependency &apos;xxx&apos;, &apos;~&gt; 15.2.0&apos;</span><br><span class="line"></span><br><span class="line"> s.pod_target_xcconfig = &#123;</span><br><span class="line">   &apos;FRAMEWORK_SEARCH_PATHS&apos; =&gt; &apos;$(inherited) $(PODS_ROOT)/xxx&apos;,</span><br><span class="line">   &apos;OTHER_LDFLAGS&apos;          =&gt; &apos;$(inherited) -undefined dynamic_lookup&apos;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>


Podfile

<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pre_install <span class="keyword">do</span> <span class="params">|installer|</span></span><br><span class="line">   <span class="comment"># workaround for https://github.com/CocoaPods/CocoaPods/issues/3289</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">installer</span>.<span class="title">verify_no_static_framework_transitive_dependencies</span>;</span> <span class="keyword">end</span></span><br><span class="line"> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>校验不同 target 所引用的代码中，如果包含 swift，所使用的 swift 版本是否相同。如果不同则会报出如下错误：</p>
  <figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The following pods are integrated into targets that <span class="keyword">do</span> <span class="keyword">not</span> have the same Swift <span class="symbol">version:</span>&#123;error_messages.join&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>当在 swift 中使用时，校验是否在 <code>Podfile</code> 中是否添加了 <code>use_frameworks!</code>。如果不添加便会报错。例如：</p>
<p>  Podfile</p>
  <figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">source <span class="string">'https://github.com/CocoaPods/Specs.git'</span></span><br><span class="line">platform <span class="symbol">:ios</span>, <span class="string">'8.0'</span></span><br><span class="line"><span class="comment"># ignore all warnings from all pods</span></span><br><span class="line">inhibit_all_warnings!</span><br><span class="line"></span><br><span class="line">target <span class="string">'SwiftTest'</span> <span class="keyword">do</span></span><br><span class="line">	   pod <span class="string">'AFNetworking'</span>,<span class="string">'3.0'</span></span><br><span class="line">	   pod <span class="string">'Alamofire'</span>, <span class="string">'~&gt; 4.6'</span></span><br><span class="line"> 	   pod <span class="string">'YYCache'</span></span><br><span class="line">	   pod <span class="string">'YYImage'</span></span><br><span class="line">	   pod <span class="string">'YYImage'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>对上述 `Podfile` 文件，执行 `pod install` 时便会报出如下错误：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[!] Pods written in Swift can only be integrated as frameworks; add `use_frameworks!` to your Podfile or target to opt into using it. The Swift Pod being used is: Alamofire</span><br></pre></td></tr></table></figure>
</code></pre><h6 id="整合-project-文件"><a href="#整合-project-文件" class="headerlink" title="整合 project 文件"></a>整合 project 文件</h6><p>依赖文件下载完毕之后，会将这些文件打包成 <code>Pods.xcodeproj</code>。这一过程方法定义如下:</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line"> <span class="comment"># Generate the 'Pods/Pods.xcodeproj' project.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_pods_project</span><span class="params">(generator = create_generator)</span></span></span><br><span class="line">  UI.section <span class="string">'Generating Pods project'</span> <span class="keyword">do</span></span><br><span class="line">    generator.generate!</span><br><span class="line">    @pods_project = generator.project</span><br><span class="line">    run_podfile_post_install_hooks</span><br><span class="line">    generator.write</span><br><span class="line">    generator.share_development_pod_schemes</span><br><span class="line">    write_lockfiles</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这里会通过 <code>generator</code> 实例执行 <code>generate!</code> 方法。我们主要说一下这个方法：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CocoaPods/lib/cocoapods/installer/xcode/pods_project_generator.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate!</span></span></span><br><span class="line">  prepare</span><br><span class="line">  install_file_references</span><br><span class="line">  install_libraries</span><br><span class="line">  integrate_targets</span><br><span class="line">  set_target_dependencies</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这个方法做了这样几件事：</p>
<ul>
<li>生成一个 <code>Pods.xcodeproj</code> 工程</li>
<li>将下载的依赖文件加入工程</li>
<li>将下载的 Library 加入工程</li>
<li>处理 target 依赖</li>
</ul>
<p>这一系列过程的操作，主要依赖于前面所提到的 <strong><a href="https://github.com/CocoaPods/Xcodeproj" target="_blank" rel="noopener">CocoaPods/Xcodeproj</a></strong> 组件。</p>
<h6 id="执行下载过程"><a href="#执行下载过程" class="headerlink" title="执行下载过程"></a>执行下载过程</h6><p>这是最后一个阶段，会下载每个组件的具体源文件，并输出最终的执行结果。方法定义如下：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># CocoaPods/lib/cocoapods/installer.rb</span></span><br><span class="line">	<span class="comment"># Performs any post-installation actions</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">perform_post_install_actions</span></span></span><br><span class="line">  unlock_pod_sources</span><br><span class="line">  run_plugins_post_install_hooks</span><br><span class="line">  warn_for_deprecations</span><br><span class="line">  warn_for_installed_script_phases</span><br><span class="line">  lock_pod_sources</span><br><span class="line">  print_post_install_message</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这一过程一般是最慢的一个过程。偷懒一下，其中的过程方法我就不一一讲解了。看一下最后输出信息这个方法吧：</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_post_install_message</span></span></span><br><span class="line">  podfile_dependencies = podfile.dependencies.uniq.size</span><br><span class="line">  pods_installed = root_specs.size</span><br><span class="line">  title_options = &#123; <span class="symbol">:verbose_prefix</span> =&gt; <span class="string">'-&gt; '</span>.green &#125;</span><br><span class="line">  UI.titled_section(<span class="string">'Pod installation complete! '</span> \</span><br><span class="line">                    <span class="string">"There <span class="subst">#&#123;podfile_dependencies == <span class="number">1</span> ? <span class="string">'is'</span> : <span class="string">'are'</span>&#125;</span> <span class="subst">#&#123;podfile_dependencies&#125;</span> "</span> \</span><br><span class="line">                    <span class="string">"<span class="subst">#&#123;<span class="string">'dependency'</span>.pluralize(podfile_dependencies)&#125;</span> from the Podfile "</span> \</span><br><span class="line">                    <span class="string">"and <span class="subst">#&#123;pods_installed&#125;</span> total <span class="subst">#&#123;<span class="string">'pod'</span>.pluralize(pods_installed)&#125;</span> installed."</span>.green,</span><br><span class="line">                    title_options)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>也就是我们常见的输出结果：</p>
<p>!()[]</p>
<p>执行一次 <code>pod install</code> 的过程到此结束了。如果你大致读一遍源码，执行 <code>pod install</code> 再遇到问题时，可以快速断定问题原因并修复。<code>pod update</code> 和 <code>pod install</code> 还是有一些差别的，有兴趣的同学可以读一下 <code>pod update</code> 的源码。我这里就不在写了，就算你读不吐我都快写吐了。</p>
<h3 id="CocoaPods-使用"><a href="#CocoaPods-使用" class="headerlink" title="CocoaPods 使用"></a>CocoaPods 使用</h3><h4 id="1-安装-CocoaPods"><a href="#1-安装-CocoaPods" class="headerlink" title="1.安装 CocoaPods"></a>1.安装 CocoaPods</h4><p>这里假设你什么都没有安装，从 0 开始。如果你已经安装了某些东西，可以跳过。</p>
<ul>
<li><p>安装 rvm</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -L get.rvm.io | bash -s stable </span><br><span class="line"></span><br><span class="line">source ~/.bashrc</span><br><span class="line"></span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>查看 rvm 版本</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm -v</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm 1.29.3 (latest) by Michal Papis, Piotr Kuczynski, Wayne E. Seguin [https://rvm.io]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>查看可安装 Ruby 版本</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm list known</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>安装一个版本，我一般选最高，这里是 2.4.1</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm intall 2.4.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为你后面可能会稀里糊涂装很多版本，所以设置这个版本为默认版本</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm use 2.4.1 --default</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>更换 Ruby 源。因为国内被墙，所以需要切换。之前很多教程中说使用 <a href="https://ruby.taobao.org，但是淘宝源已经停止维护，现在建议使用" target="_blank" rel="noopener">https://ruby.taobao.org，但是淘宝源已经停止维护，现在建议使用</a> <a href="https://gems.ruby-china.org。" target="_blank" rel="noopener">https://gems.ruby-china.org。</a></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	sudo gem update --system</span><br><span class="line"></span><br><span class="line">	gem sources --remove https://rubygems.org/</span><br><span class="line"></span><br><span class="line">	gem sources -a https://gems.ruby-china.org/</span><br><span class="line">	</span><br><span class="line">	// 查看当前源</span><br><span class="line">	gem sources -l</span><br><span class="line">	``` </span><br><span class="line"></span><br><span class="line">* 安装 CocoaPods</span><br></pre></td></tr></table></figure>
<p>  // 安装 CocoaPods<br>  sudo gem install cocoapods</p>
<p>  // 安装本地库，需要等待很长时间<br>  pod setup</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 如果安装了多个 Xcode，需要选择一个。</span><br></pre></td></tr></table></figure>
<p>  sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">* 检测是否安装好，search 一个组件，能 search 到证明安装好了</span><br></pre></td></tr></table></figure>
<p>  pod search [一个组件]</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">* CocoaPods 版本操作</span><br></pre></td></tr></table></figure>
<p>  // 查看当前安装的所有 CocoaPods 版本<br>   gem list –local | grep cocoapods</p>
<p>  // 当前使用 pod 版本<br>  pod –version</p>
<p>  // 更新到最新稳定版本<br>  sudo gem install cocoapods</p>
<p>  // 更新到一个 pre-release 版本<br>  sudo gem install cocoapods –pre</p>
<p>  // 安装指定版本<br>  sudo gem install cocoapods -v [版本号]</p>
<p>  // 移除 CocoaPods，如果你安装多个，会列出一个 list 让你选择删除那个。如果只安装一个，也会给你提示，问你是否确定删除。<br>  sudo gem uninstall cocopods</p>
<p>  // 移除指定版本<br>  sudo gem uninstall cocopods -v [版本号]</p>
<p>  // 使用指定版本执行命令<br>  pod <em>1.3.1</em> install</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">#### 2.使用 CocoPods</span><br><span class="line"></span><br><span class="line">* 基础操作</span><br></pre></td></tr></table></figure>
<p>  // 打开一新的工程，执行命令<br>  pod init<br>  // Podfile 中添加<br>  pod ‘AFNetworking’<br>  // install<br>  pod install</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 想要看到 install 的详细过程</span><br></pre></td></tr></table></figure>
<p>  pod install –verbose</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 更新某一个组件</span><br></pre></td></tr></table></figure>
<p>  // 不添加组件名则更新所有<br>  pod update [组件名]</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">* 更新本地依赖</span><br></pre></td></tr></table></figure>
<p>  pod repo update</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 不想在 install/update 时更新本地依赖。这样执行 `pod install` 会快一些。但是如果 github 或者私有仓库上面有了最新版本，本地搜到的还是旧版本。如果 `Podfile` 中使用新的版本号，这样是无法执行成功的。</span><br></pre></td></tr></table></figure>
<p>  // –verbose 可省略<br>  pod install –verbose –no-repro-update</p>
<p>  pod update –verbose –no-repro-update</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 校验本地 lib repro 有效性</span><br></pre></td></tr></table></figure>
<p>  pod lib lint –allow-warnings</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 校验 spec 文件</span><br></pre></td></tr></table></figure>
<p>  pod spec lint</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">* 自定义组件时，将组件的 spec 文件上传到远端仓库。</span><br></pre></td></tr></table></figure>
<p>  // [reponame] 一般可以在路径 ~/.cocoapods/repo 下查看，选择你需要的 name.<br>  pod repo push [reponame] [name.podspec] –verbose –sources=master,[reponame] –use-libraries –allow-warnings</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">想了解更多命令，请查看官方文档中 [Command Line API](https://guides.cocoapods.org/terminal/commands.html) 这一章节。</span><br><span class="line"></span><br><span class="line">#### Podfile 书写规范</span><br><span class="line"></span><br><span class="line">[Podfile Syntax Reference v1.4.0](https://guides.cocoapods.org/syntax/podfile.html#script_phase)</span><br><span class="line"></span><br><span class="line">```rb</span><br><span class="line">source &apos;https://github.com/CocoaPods/Specs.git&apos; # 组件依赖文件所存放仓库，根据需求可引入多个</span><br><span class="line">source &apos;https://github.com/artsy/Specs.git&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">platform :ios, &apos;8.0&apos;            # </span><br><span class="line">inhibit_all_warnings!           # 忽视引用的代码中的警告</span><br><span class="line"></span><br><span class="line">workspace &apos;CocoaPodsDemo&apos;       # 指定生成的 workspace 名字</span><br><span class="line"></span><br><span class="line">def common_pods                 # 如果有多个 target，可以将公共部分进行 def 定义再引入</span><br><span class="line">    pod &apos;xxx&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">target &apos;CocoaPodsDemo&apos; do</span><br><span class="line">    project &apos;DemoProject&apos;       # 可用于指定实际的工程</span><br><span class="line"></span><br><span class="line">    use_frameworks!             # 是否以 framework 形式引入。swift 必须有这个关键字 </span><br><span class="line"></span><br><span class="line">    common_pods     			   # 公共引入的组件</span><br><span class="line"></span><br><span class="line">    pod &apos;SSipArchive&apos;, :inhibit_warnings =&gt; true   # 屏蔽某个 pod 的 warning</span><br><span class="line"></span><br><span class="line">    pod &apos;AFNetworking&apos;, &apos;3.2&apos;   # 使用 3.2 版本</span><br><span class="line">    pod &apos;YYCache&apos;, &apos;~&gt; 0.3&apos;     # pod update 时最高升级到 &lt; 1.0，不包括 1.0</span><br><span class="line">	  </span><br><span class="line">	 # Build 环境配置</span><br><span class="line">	 pod &apos;PonyDebugger&apos;, :configurations =&gt; [&apos;Debug&apos;, &apos;Beta&apos;]</span><br><span class="line">	 pod &apos;PonyDebugger&apos;, :configuration =&gt; &apos;Debug&apos;</span><br><span class="line"></span><br><span class="line">	 # 使用具体的某个 subspec</span><br><span class="line">	 pod &apos;QueryKit/Attribute&apos;</span><br><span class="line">	 pod &apos;QueryKit&apos;, :subspecs =&gt; [&apos;Attribute&apos;, &apos;QuerySet&apos;]</span><br><span class="line">	 </span><br><span class="line">	 # 引用本地组件</span><br><span class="line">	 pod &apos;AFNetworking&apos;, :path =&gt; &apos;~/Documents/AFNetworking&apos;</span><br><span class="line">	 </span><br><span class="line">	 # 使用具体仓库</span><br><span class="line">	 pod &apos;AFNetworking&apos;, :git =&gt; &apos;https://github.com/gowalla/AFNetworking.git&apos;</span><br><span class="line">	 # 使用具体仓库具体分支</span><br><span class="line">	 pod &apos;AFNetworking&apos;, :git =&gt; &apos;https://github.com/gowalla/AFNetworking.git&apos;, :branch =&gt; &apos;dev&apos;</span><br><span class="line">	 # 使用具体仓库的某个 tag</span><br><span class="line">	 pod &apos;AFNetworking&apos;, :git =&gt; &apos;https://github.com/gowalla/AFNetworking.git&apos;, :tag =&gt; &apos;0.7.0&apos;</span><br><span class="line">	 # 使用具体仓库的某个 commit</span><br><span class="line">	 pod &apos;AFNetworking&apos;, :git =&gt; &apos;https://github.com/gowalla/AFNetworking.git&apos;, :commit =&gt; &apos;082f8319af&apos;</span><br><span class="line">    </span><br><span class="line">    # 使用指定路径的 spec 文件</span><br><span class="line">	 pod &apos;JSONKit&apos;, :podspec =&gt; &apos;https://example.com/JSONKit.podspec&apos;</span><br><span class="line">	 </span><br><span class="line">	 </span><br><span class="line">	 target &apos;ShowsApp&apos; do</span><br><span class="line"> 		 pod &apos;ShowsKit&apos;</span><br><span class="line"></span><br><span class="line">  		# Has its own copy of ShowsKit + ShowTVAuth</span><br><span class="line">  		 target &apos;ShowsTV&apos; do</span><br><span class="line">   		 pod &apos;ShowTVAuth&apos;</span><br><span class="line">  		 end</span><br><span class="line"></span><br><span class="line">  		# Has its own copy of Specta + Expecta</span><br><span class="line">  		# and has access to ShowsKit via the app</span><br><span class="line">     # that the test target is bundled into</span><br><span class="line">    	target &apos;ShowsTests&apos; do</span><br><span class="line">    	 # inherit！ 有三种类型：&apos;:complete&apos; 继承父级所有行为；&apos;:none&apos; 什么行为都不继承；&apos;:search_paths&apos; 继承父级的 search paths</span><br><span class="line">     		inherit! :search_paths</span><br><span class="line">      	pod &apos;Specta&apos;</span><br><span class="line">      	pod &apos;Expecta&apos;</span><br><span class="line">    	end</span><br><span class="line">	 end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># hook 配置, 在 preparing 阶段后，install 之前</span><br><span class="line">pre_install do |installer|</span><br><span class="line">    </span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># hook 配置，在 pod install 之后，可用于修改工程配置等</span><br><span class="line">post_install do |installer|</span><br><span class="line">  installer.pods_project.targets.each do |target|</span><br><span class="line">    target.build_configurations.each do |config|</span><br><span class="line">      config.build_settings[&apos;GCC_ENABLE_OBJC_GC&apos;] = &apos;supported&apos;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Podspec-书写规范"><a href="#Podspec-书写规范" class="headerlink" title="Podspec 书写规范"></a>Podspec 书写规范</h4><p><a href="https://guides.cocoapods.org/syntax/podspec.html" target="_blank" rel="noopener">Podspec Syntax Reference v1.4.0</a></p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">Pod::Spec.new <span class="keyword">do</span> <span class="params">|spec|</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件基本信息配置</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">   <span class="comment"># 组件名</span></span><br><span class="line">  spec.name         = <span class="string">'Reachability'</span></span><br><span class="line">  <span class="comment"># 组件版本号，命名规则遵循 [semantic versioning](https://semver.org/)</span></span><br><span class="line">  spec.version      = <span class="string">'3.1.0'</span>    </span><br><span class="line">  <span class="comment"># 许可证</span></span><br><span class="line">  spec.license      = &#123; <span class="symbol">:type</span> =&gt; <span class="string">'BSD'</span> &#125;</span><br><span class="line">  <span class="comment"># 仓库主页</span></span><br><span class="line">  spec.homepage     = <span class="string">'https://github.com/tonymillion/Reachability'</span></span><br><span class="line">  <span class="comment"># 一个作者用 spec.author = 'Darth Vader'</span></span><br><span class="line">  spec.authors      = &#123; <span class="string">'Tony Million'</span> =&gt; <span class="string">'tonymillion@gmail.com'</span> &#125;</span><br><span class="line">  <span class="comment"># 组件概述</span></span><br><span class="line">  spec.summary      = <span class="string">'ARC and GCD Compatible Reachability Class for iOS and OS X.'</span></span><br><span class="line">  <span class="comment"># 组件源码地址</span></span><br><span class="line">  spec.source       = &#123; <span class="symbol">:git</span> =&gt; <span class="string">'https://github.com/tonymillion/Reachability.git'</span>, <span class="symbol">:tag</span> =&gt; <span class="string">'v3.1.0'</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件平台支持</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">	<span class="comment"># 支持单平台使用</span></span><br><span class="line">  spec.platform = <span class="symbol">:osx</span>, <span class="string">'10.8'</span></span><br><span class="line">  spec.platform = <span class="symbol">:ios</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 支持多平台使用</span></span><br><span class="line">	spec.ios.deployment_target = <span class="string">'6.0'</span></span><br><span class="line">	spec.osx.deployment_target = <span class="string">'10.8'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build settings</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">	spec.dependency <span class="string">'AFNetworking'</span>, <span class="string">'~&gt; 1.0'</span>    <span class="comment"># 组件依赖的第三方库</span></span><br><span class="line">	spec.requires_arc = <span class="literal">false</span>                   <span class="comment"># 是否要求 ARC 环境</span></span><br><span class="line">	spec.requires_arc = [<span class="string">'Classes/*ARC.m'</span>, <span class="string">'Classes/ARC.mm'</span>]</span><br><span class="line">	spec.frameworks = <span class="string">'QuartzCore'</span>, <span class="string">'CoreData'</span>  <span class="comment"># 组件引用的 framework	spec.weak_frameworks = 'Twitter', 'SafariServices' # 组件弱引用的 framework</span></span><br><span class="line">	spec.libraries = <span class="string">'xml2'</span>, <span class="string">'z'</span>                <span class="comment"># 组件引用的 library</span></span><br><span class="line">	... 更多请看官方文档</span><br><span class="line">	</span><br><span class="line"><span class="comment"># File patterns</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">	spec.source_files = <span class="string">'Classes/**/*.&#123;h,m&#125;'</span>          <span class="comment"># 接入方使用组件时，引入的源文件，正则匹配</span></span><br><span class="line">	spec.public_header_files = <span class="string">'Headers/Public/*.h'</span>   <span class="comment"># 引入的共有头文件</span></span><br><span class="line">	spec.private_header_files = <span class="string">'Headers/Private/*.h'</span> <span class="comment"># 引入的私有头文件</span></span><br><span class="line">	spec.vendored_frameworks = <span class="string">'MyFramework.framework'</span><span class="comment"># 引入的 framework</span></span><br><span class="line">	spec.vendored_libraries = <span class="string">'libProj4.a'</span>            <span class="comment"># 引入的 library</span></span><br><span class="line">	<span class="comment"># 以 bundle 形式引入的资源</span></span><br><span class="line">	spec.resource_bundles = &#123;</span><br><span class="line">    <span class="string">'MapBox'</span> =&gt; [<span class="string">'MapView/Map/Resources/*.png'</span>],</span><br><span class="line">    <span class="string">'OtherResources'</span> =&gt; [<span class="string">'MapView/Map/OtherResources/*.png'</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># 直接引入资源</span></span><br><span class="line">  spec.resources = [<span class="string">'Images/*.png'</span>, <span class="string">'Sounds/*'</span>]</span><br><span class="line">	... 更多请看官方文档</span><br><span class="line"></span><br><span class="line"><span class="comment"># Subspecs</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">	<span class="comment"># 将组件分为多个子组件，接入方可以根据需求只接入几个子组件，减少包体积</span></span><br><span class="line">	subspec <span class="string">'Twitter'</span> <span class="keyword">do</span> <span class="params">|sp|</span></span><br><span class="line">  		sp.source_files = <span class="string">'Classes/Twitter'</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment"># 测试组件</span></span><br><span class="line">  spec.test_spec <span class="keyword">do</span> <span class="params">|test_spec|</span></span><br><span class="line">    test_spec.source_files = <span class="string">'NSAttributedString+CCLFormatTests.m'</span></span><br><span class="line">    test_spec.dependency <span class="string">'Expecta'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">	<span class="comment"># 默认子组件。也就是当接入方不作区分时，直接使用组件名引入时，所引入子组件</span></span><br><span class="line">	spec.default_subspec = <span class="string">'Core'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多平台支持</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">	spec.ios.source_files = <span class="string">'Classes/ios/**/*.&#123;h,m&#125;'</span></span><br><span class="line">	spec.osx.source_files = <span class="string">'Classes/osx/**/*.&#123;h,m&#125;'</span></span><br></pre></td></tr></table></figure>
<p>Cocopods 基本使用内容就这些。具体可以查看官方文档中 <a href="https://guides.cocoapods.org/" target="_blank" rel="noopener">Reference</a> 这一章节。</p>
<h3 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h3><p>这里是一些经常遇到的问题。不是很全面，希望对你有帮助。</p>
<h4 id="1-项目使用了-CocoaPods-之后，为什么要以-Workspace-形式打开"><a href="#1-项目使用了-CocoaPods-之后，为什么要以-Workspace-形式打开" class="headerlink" title="1.项目使用了 CocoaPods 之后，为什么要以 Workspace 形式打开"></a>1.项目使用了 CocoaPods 之后，为什么要以 Workspace 形式打开</h4><p>因为执行 <code>pod install</code> 之后，下载完的文件会通过使用 <a href="https://github.com/CocoaPods/Xcodeproj" target="_blank" rel="noopener">CocoaPods/Xcodeproj</a> 合成一个 Project。Xcode 通过使用 Workspace 管理多个 Project，使各个 Project 之间可以相互引用。为了使工程中的文件能够引用组件中的文件，所以这里需要以 Workspace 形式打开。</p>
<h4 id="2-pod-install-vs-pod-update"><a href="#2-pod-install-vs-pod-update" class="headerlink" title="2.pod install vs. pod update"></a>2.pod install vs. pod update</h4><p>这是 <a href="https://guides.cocoapods.org/using/pod-install-vs-update.html" target="_blank" rel="noopener">官方文档</a> 中描述的一个经典问题。</p>
<p><strong>pod install</strong>: 优先安装 Podfile 中改变的组件，并优先遵循 Podfile 中的版本号，其次遵循 Podfile.lock 中的版本号。如果使用的 Podfile 中版本号，会将新的版本号更新到 Podfile.lock 中。</p>
<p><strong>pod update [PODNAME]</strong>: 会根据当前 Podfile 规则更新组件。如果 Podfile 中没有指定版本号，并不会遵循 Podfile.lock，而是会拉取最新版本，并更新 Podfile.lock。</p>
<p>官方建议：</p>
<ul>
<li>新添加一个 pod 时，使用 <code>pod install</code>，不要使用 <code>pod update</code> 去下载一个新的组件，避免跟新其他 pod 的版本。</li>
<li>更新 pod 版本时，使用 <code>pod update [PODNAME]</code>。</li>
<li>没有必要的话，不要使用全局更新 <code>pod update</code>，避免不必要的更新。</li>
</ul>
<h4 id="3-校验-podspec-文件出现问题（pod-spec-lint）"><a href="#3-校验-podspec-文件出现问题（pod-spec-lint）" class="headerlink" title="3.校验 podspec 文件出现问题（pod spec lint）"></a>3.校验 podspec 文件出现问题（pod spec lint）</h4><p><strong>swift 版本问题</strong></p>
<p>问题：</p>
<p><img src="/uploads/Cocoa-Pods/swfit_error.png" alt="swift_error"></p>
<p>解决方案:</p>
<blockquote>
<p>2.3, run终端输入：echo “2.3” &gt; .swift-version</p>
</blockquote>
<p><strong>验证出现警告问题</strong></p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod spec lint xxx.podspec --allow-warning</span><br></pre></td></tr></table></figure>
<p><strong>找不到头文件</strong></p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod spec lint --allow-warnings --use-libraries</span><br></pre></td></tr></table></figure>
<p>当然 CocoaPods 还有很多问题，这里就不一一列举了，如果遇到问题自行 Google 吧，很多问题都已经有了答案。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>CocoaPods 的相关知识，就总结到这里。花时间如仔细研究一下，还是能学到很多东西的。这样在今后的项目开发中遇到问题后，可以快速定位并解决，提高开效率。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p>1.<a href="https://cocoapods.org/" target="_blank" rel="noopener">CocoaPods 官方文档</a><br>2.<a href="https://www.objc.io/issues/6-build-tools/cocoapods-under-the-hood/" target="_blank" rel="noopener">CocoaPods Under The Hood</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/02/28/My-Understand-Block/" class="prev">PREV</a><a href="/2018/02/13/annual-report-2017/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
    id: 'Fri Feb 16 2018 17:09:23 GMT+0800',
    owner: 'boolchow',
    repo: 'boolchow.github.io',
    oauth: {
        client_id: '06247ad6645fcdc4c37c',
        client_secret: 'b3107efca11a366f4da8281d78bf59880f19a253',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">John Doe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p><script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1273864579'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1273864579%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>